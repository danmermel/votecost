<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta content="width=device-width,initial-scale=1,minimal-ui" name="viewport">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.7.19/dist/vuetify.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css" />
  <link rel="stylesheet" href="https://fonts.bunny.net/css?family=roboto:400,500,700" />
  <script type="importmap">
    {
      "imports": {
        "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
        "vuetify": "https://cdn.jsdelivr.net/npm/vuetify@3.7.19/dist/vuetify.esm.js",
        "api_url": "./api_url.js"
      }
    }
    </script>
  <style>
    [v-cloak] {
      display: none;
    }

    .v-btn {
      margin-bottom: 20px;
    }

    input {
      font-size: 2rem;
    }
  </style>
  <title>Vote Cost 2024</title>
  <link rel="manifest" href="votecost.webmanifest" />
</head>

<body>
  <v-layout v-cloak id="app">
    <v-app theme="light">
      <v-app-bar density="compact" color="#009688">
        <v-app-bar-title style="user-select:none;">Vote Cost 2024</v-app-bar-title>
      </v-app-bar>
      <v-main>
        <v-container fluid>
          <v-autocomplete @update:model-value="findresults" label="Choose a constituency (start typing a name)" :items="constituencies"
            item-title="constituency" v-model="constituency"></v-autocomplete>
          <v-alert v-if="message">{{message}}</v-alert>
          <v-data-table v-if="!nodata" hide-default-footer :items="showdata" v-model:sort-by="sortBy"></v-data-table>
        </v-container>
      </v-main>
      <v-footer class="text-center d-flex flex-column ga-2 py-4">
        <div class="text-caption font-weight-regular">
          <p>How much did your vote cost?</p>
          <p>Use this site to find out how much a candidate spent in the 2024 General
            Election, how many votes that candidate got and, therefore, how much they paid for each vote obtained.</p>
          <strong>Sources:</strong>The UK Parliament has a record of <a
            href=" https://electionresults.parliament.uk/general-elections/6/turnout">how many</a> votes every candidate
          received. The Electoral Commission publishes data on <a
            href="https://www.electoralcommission.org.uk/political-registration-and-regulation/financial-reporting/campaign-spending-candidates/2024-uk-parliamentary-general-election-candidate-spending?section=data&filters=%255B%257B%2522candidate%2522%253A%257B%2522id%2522%253A2122%252C%2522value%2522%253A%2522yuan%2520yang%2522%252C%2522label%2522%253A%2522Yuan%2520Yang%2522%252C%2522meta%2522%253A%255B%2522Labour%2520Party%2522%252C%2522Earley%2520and%2520Woodley%2522%255D%257D%257D%255D">how
            much</a> each candidate spent.
          To see how these data sets were combined, see the project's <a
            href="https://github.com/danmermel/votecost">Github repository</a>.
        </div>
        <v-divider></v-divider>
    </v-app>
  </v-layout>

  <script type="module">
    // imports
    import { createApp, ref, computed } from "vue"
    import { createVuetify } from "vuetify"
    import api_url from "api_url"

    // use vuetify for UI
    const vuetify = createVuetify()

    // create Vue.js app
    createApp({

      setup() {
        // app state
        const constituency = ref('')
        const url = api_url
        const message = ref('')
        const constituencies = ref([])
        const showdata = ref([])
        const nodata = ref(true)
        const sortBy = ref([{ key: 'Position', order: 'asc' }])

        async function fetchconstituencies() {
          const rawResponse = await fetch(url, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ "sql": 'select distinct constituency_id, constituency from expenditure order by constituency asc ', "params": [] })
          });
          constituencies.value = (await rawResponse.json()).message
          //console.log(constituencies.value)
        }


        async function findresults(constituencyName) {
          const rawResponse = await fetch(url, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ "sql": 'select * from expenditure inner join results on expenditure.resultid = results.id where constituency = ? ', "params": [constituencyName] })
          });
          //get just the data we want into the array
          showdata.value = (await rawResponse.json()).message.map(function (i) {
            return {
              Position: i.candidate_result_position,
              Candidate: `${i.candidate_given_name} ${i.candidate_family_name}`,
              Party: i.candidate_party,
              Votes: i.candidate_vote_count,
              Spending: new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(i.total_reported_spending),
              "Cost per Vote": new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format((i.total_reported_spending / i.candidate_vote_count).toFixed(2))
            }
          })
          nodata.value = false
          //console.log(showdata)  
        }

        //hydrate constituencies
        fetchconstituencies()

        // make state available


        return {
          constituency,
          constituencies,
          findresults,
          message,
          showdata,
          nodata,
          sortBy
        }
      }
    }).use(vuetify).mount('#app')



  </script>
</body>

</html>